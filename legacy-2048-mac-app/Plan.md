# 2048 macOS App 最终版计划（动画驱动，结果导向）

## 结论与决策（最终）
- 现有 SwiftUI 动画路径无法稳定达到“真实合成、吸收、变大”的体验，正式弃用该动画实现。
- 采用 **SpriteKit 作为动画引擎**，以动画时间线驱动视觉状态；逻辑仅作为计算来源。
- 不追求最小改动，只追求最终效果；必要时整体重构。

## 约束（不可违反）
- 所有文件仅存放在 `/Users/furyu/Desktop/2048-mac-app/`。
- 最终交付为可双击运行的 macOS App，并更新桌面快捷方式 `2048.app`。
- 目标是“用户看到即相信真实合成”，不接受“突兀消失/重叠/空方块”。

## 用户体验目标（必须达到）
- 按方向键后，方块**真实滑动**到目标格，路径连续无瞬移。
- 合并过程为：**先到者停下 → 后到者撞上 → 挤入吸收 → 合成结果弹出**。
- 合并后结果块**稳定留在格内**，不会消失、不会空白、不会重叠。

## 动画驱动架构（核心方案）
### A1 视觉真相唯一化
- **动画时间线是唯一视觉来源**，棋盘显示不提前露出最终结果。
- 逻辑仅用于生成“动作序列”，视觉按序列播放。

### A2 动画时间线（确定性）
- 每步操作生成 `MoveTimeline`：
  - 移动段（Move）：所有可移动块同步滑动。
  - 碰撞段（Hit）：后到者撞上并挤入。
  - 吸收段（Absorb）：后到者缩小/淡出，被吸收。
  - 合成段（MergePop）：结果块弹出并稳定。
- 时间全部固定为“确定值”，无随机时长，确保一致性。

### A3 坐标系统与层级
- 以棋盘左上角为坐标原点，严格映射格子坐标。
- 动画层与棋盘层共用统一坐标、间距、尺寸。
- 严格控制 Z 顺序：移动块在上，结果块在合成段出现。

## 实施步骤（必须按顺序）
### S1 引擎切换与场景搭建
- SwiftUI 仅用于外壳和按钮，棋盘用 SpriteKit 渲染。
- 创建 `GameScene`，在场景内绘制格子、方块。

### S2 动画数据结构
- `TileInstance`：每个方块的显示实例。
- `MoveEvent`：记录 from/to、时间段、碰撞与合并关系。
- `MoveTimeline`：一组 MoveEvent + 阶段时间。

### S3 动画播放器
- 统一时钟驱动帧更新（不可依赖系统默认动画）。
- 每一步仅执行一个时间线，结束前禁止新输入。

### S4 合并特效
- 后到者撞击停顿（短暂停留）。
- 吸收：缩小至 0.88 + 透明度下降。
- 结果块弹出：放大至 1.06 后稳定 1.0。

### S5 逻辑融合
- 逻辑仍由现有规则计算，但结果只在时间线完成后生效。
- 视觉与逻辑严格同步，不允许提前显示。

### S6 自动游玩与提示
- AI 出下一步只在动画完成后执行。
- 自动游玩节奏 1.0 秒/步，严格等待动画完成。

## 验收标准（硬性）
- 2+2 右移：右侧 2 先停、左侧 2 撞上吸收，最终 4 稳定在最右格。
- 2 2 2 2 左移：结果必须为 4 4，且无重叠、无空白。
- 任意方向移动 30 步：无空方块、无棋盘外残影、无消失。
- 合并后结果块必定可见且稳定停留。

## 交付物
- 通过验收的可运行 macOS App（双击运行）。
- 桌面快捷方式 `2048.app`。
- 所有源码与资源仅在 Desktop 项目目录内。
